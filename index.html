<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600&family=Josefin+Sans:wght@700&display=swap">
    <title>NP Ultra Viewer</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: white;
        }

        #container {
            display: flex;
            flex-wrap: wrap;
            max-width: 95%;
        }

        #probeGraphic {
            width:10%;
        }

        #unity-canvas {
            width: 70%;
            max-width: 1000px; /* Adjust the width as needed */
            margin-bottom: 20px;
        }

        #imageContainer {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #pngImage, #gifImage, #probeImage {
            width: 100%;
            margin-bottom: 20px;
        }

        #dataTable {
            max-width: 80%;
            margin-bottom: 20px;
        }

        #dataTable th {
            font-family: 'Josefin Sans', sans-serif;
            font-weight: 500; /* Make it bold */
        }

        #dataTable td {
            font-family: 'Josefin Sans', sans-serif;
            font-weight: 300; /* Make it thin */
        }

        .buttonContainer {
            position: absolute;
            bottom: 0;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin: 10px;
        }

        .button {
            background-color: lightblue;
            color: white;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #searchInput {
            min-width: 50%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            outline: none;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <input type="text" id="searchInput" placeholder="Search by acronym..." onkeydown="searchOnEnter(event)">

    <div id="container">
        <div id="probeGraphic">
            <img id="probeImage" src="images/ultra_probe.svg" alt="Ultra Probe">
        </div>

        <canvas id="unity-canvas"></canvas>

        <div id="imageContainer">
            <img id="pngImage" src="" alt="PNG Image">
            <img id="gifImage" src="" alt="GIF Image">
        </div>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
            </tr>
        </thead>
        <tbody>
            <tr>
            </tr>
        </tbody>
    </table>
    
    <div class="buttonContainer">
        <a href="https://www.biorxiv.org/content/10.1101/2023.08.23.554527"><button class="button">Paper</button></a>
        <button class="button">Share</button>
    </div>

    <script>
    var myGameInstance;
    
    function updateSelection(idx) {
        // Note that the data row is idx-1 but the images are idx (MATLAB people...)

        if (!csvData) {
            console.error('CSV data not loaded yet.');
            return;
        }

        if (idx < 0 || idx >= csvData.length) {
            console.error('Invalid row index:', idx);
            return;
        }

        const selectedRow = csvData[idx-1];

        // Update table
        const table = document.getElementById('dataTable');
        const tbody = table.querySelector('tbody');

        // Clear existing rows in the tbody
        tbody.innerHTML = '';

        // Create a new row and cells for the selected data
        const newRow = tbody.insertRow();
        for (const key in selectedRow) {
            const cell = newRow.insertCell();
            cell.textContent = selectedRow[key];
        }

        // Change the image lement sources
        document.getElementById('gifImage').src = `images/gif/neuron${idx}.gif`;
        document.getElementById('pngImage').src = `images/png/neuron${idx}.png`;
    }

    function searchOnEnter(event) {
        if (event.key == 'Enter') {
            console.log(`Searched for ${event.target.value}`);
            myGameInstance.SendMessage('main', 'Search', event.target.value);
        }
    }

    let csvData = null;

    // Function to load the CSV file and cache the data
    async function loadCSVFile() {
        try {
            const response = await fetch('./metadata_stripped.csv');
            const csvText = await response.text();
            csvData = parseCSV(csvText);
        } catch (error) {
            console.error('Error loading CSV file:', error);
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',');
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const entry = {};

            for (let j = 0; j < headers.length; j++) {
                entry[headers[j]] = values[j];
            }

            data.push(entry);
        }

        return data;
    }

    function updateTableHeaders() {
        if (!csvData || csvData.length === 0) {
            console.error('CSV data not loaded or empty.');
            return;
        }

        const table = document.getElementById('dataTable');
        const thead = table.querySelector('thead');

        // Clear existing headers in the thead
        thead.innerHTML = '';

        // Create a new row for the headers
        const headerRow = thead.insertRow();

        // Add headers based on the first row of the CSV data
        const headers = Object.keys(csvData[0]);
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
    }

    const hideFullScreenButton = "";
    const buildUrl = "build/Build";
    const loaderUrl = buildUrl + "/build.loader.js";
    const config = {
        dataUrl: buildUrl + "/build.data.unityweb",
        frameworkUrl: buildUrl + "/build.framework.js.unityweb",
        codeUrl: buildUrl + "/build.wasm.unityweb",
        streamingAssetsUrl: "build/StreamingAssets",
        companyName: "VirtualBrainLab",
        productName: "NPUltra",
        productVersion: "0.1.0",
    };

    // const container = document.querySelector("#unity-container");
    const canvas = document.querySelector("#unity-canvas");
    // const loadingCover = document.querySelector("#loading-cover");
    // const progressBarEmpty = document.querySelector("#unity-progress-bar-empty");
    // const progressBarFull = document.querySelector("#unity-progress-bar-full");
    // const fullscreenButton = document.querySelector("#unity-fullscreen-button");
    // const spinner = document.querySelector('.spinner');

    // const canFullscreen = (function() {
    //   for (const key of [
    //       'exitFullscreen',
    //       'webkitExitFullscreen',
    //       'webkitCancelFullScreen',
    //       'mozCancelFullScreen',
    //       'msExitFullscreen',
    //     ]) {
    //     if (key in document) {
    //       return true;
    //     }
    //   }
    //   return false;
    // }());

    // if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    //   container.className = "unity-mobile";
    //   config.devicePixelRatio = 1;
    // }
    // loadingCover.style.display = "";

    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
        // spinner.style.display = "none";
        // progressBarEmpty.style.display = "";
        // progressBarFull.style.width = `${100 * progress}%`;
        }).then((unityInstance) => {
            myGameInstance = unityInstance;
        }).catch((message) => {
            alert(message);
        });
    };

    loadCSVFile().then(() => {
        updateTableHeaders();

        // for testing
        updateSelection(23);
    });

    document.body.appendChild(script);
  </script>
</body>
</html>
